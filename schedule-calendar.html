<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨ã—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .filter-area {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .filter-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .filter-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .filter-item label {
            cursor: pointer;
            font-size: 14px;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .calendar-nav button:hover {
            background: #5568d3;
        }
        
        .current-month {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .calendar-header {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            background: #667eea;
            color: white;
            border-radius: 5px;
        }
        
        .calendar-day {
            min-height: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #f0f0f0;
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
        }
        
        .day-number {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .event-item {
            font-size: 11px;
            padding: 2px 4px;
            margin: 2px 0;
            border-radius: 3px;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .youtube-fetch {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .youtube-fetch input {
            flex: 1;
        }
        
        .youtube-fetch button {
            padding: 10px 20px;
            background: #FF0000;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
.time-display {
    font-size: 18px;
    font-weight: bold;
    min-width: 120px;
    text-align: center;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
}
        
        .time-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .time-buttons button {
            padding: 5px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-save {
            background: #667eea;
            color: white;
        }
        
        .btn-delete {
            background: #ff4757;
            color: white;
        }
        
        .btn-cancel {
            background: #ddd;
            color: #333;
        }
        
        /* ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³ */
        .data-management {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .data-management button {
            padding: 10px 20px;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® æ¨ã—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
        
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="filter-area">
            <div class="filter-title">è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
            <div class="filter-checkboxes" id="filterCheckboxes">
                <!-- JavaScriptã§ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="calendar-nav">
            <button onclick="changeMonth(-1)">â—€ å‰æœˆ</button>
            <div class="current-month" id="currentMonth"></div>
            <button onclick="changeMonth(1)">æ¬¡æœˆ â–¶</button>
        </div>
        
        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="calendar" id="calendar">
            <!-- JavaScriptã§ç”Ÿæˆ -->
        </div>

        <!-- ä¸€æ‹¬å–å¾—ã‚¨ãƒªã‚¢ -->
        <div class="bulk-import-area" style="margin-top: 20px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
            <div style="font-weight: bold; margin-bottom: 15px; color: #667eea; font-size: 18px;">ğŸ“º ãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰ä¸€æ‹¬å–å¾—</div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="channelUrl" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«URLã¾ãŸã¯ãƒãƒ£ãƒ³ãƒãƒ«ID" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="fetchStartDate" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1;">
                    <span style="display: flex; align-items: center;">ã€œ</span>
                    <input type="date" id="fetchEndDate" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1;">
                </div>
                
                <button onclick="bulkFetchVideos()" style="padding: 12px; background: #FF0000; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                    å‹•ç”»ã‚’ä¸€æ‹¬å–å¾—
                </button>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="data-management">
            <button onclick="exportJSON()">JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
            <button onclick="importJSON()">JSONå¾©å…ƒ</button>
        </div>
    </div>
    
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">äºˆå®šã‚’è¿½åŠ </div>
            
            <div class="form-group">
                <label>YouTube URL</label>
                <div class="youtube-fetch">
                    <input type="text" id="youtubeUrl" placeholder="https://youtube.com/...">
                    <button onclick="fetchYouTubeData()">å–å¾—</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="eventTitle" placeholder="é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«">
            </div>
            
            <div class="form-group">
                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="eventCategory" onchange="updateSubCategories()">
                    <option value="é…ä¿¡">é…ä¿¡</option>
                    <option value="å¤§ä¼š">å¤§ä¼š</option>
                    <option value="ã‚ªãƒ•ã‚¤ãƒ™">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                    <option value="ã‚°ãƒƒã‚º">ã‚°ãƒƒã‚ºç™ºå£²</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="eventSubCategory">
                    <!-- JavaScriptã§ç”Ÿæˆ -->
                </select>
            </div>
            
<div class="form-group">
    <label>é–‹å§‹æ™‚é–“</label>
    <div class="time-input-group">
        <input type="time" class="time-display" id="startTimeDisplay" value="22:00">
        <div class="time-buttons">
            <button onclick="adjustTime('start', 30)">+30åˆ†</button>
            <button onclick="adjustTime('start', -30)">-30åˆ†</button>
        </div>
    </div>
</div>

<div class="form-group">
    <label>çµ‚äº†æ™‚é–“</label>
    <div class="time-input-group">
        <input type="time" class="time-display" id="endTimeDisplay" value="01:00">
        <div class="time-buttons">
            <button onclick="adjustTime('end', 30)">+30åˆ†</button>
            <button onclick="adjustTime('end', -30)">-30åˆ†</button>
        </div>
    </div>
</div>
            
            <div class="button-group">
                <button class="btn-save" onclick="saveEvent()">ä¿å­˜</button>
                <button class="btn-delete" id="deleteBtn" onclick="deleteEvent()" style="display:none;">å‰Šé™¤</button>
                <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // ã“ã“ã«JavaScriptã‚³ãƒ¼ãƒ‰ãŒç¶šãã¾ã™

// APIã‚­ãƒ¼ï¼ˆã“ã“ã«è‡ªåˆ†ã®ã‚­ãƒ¼ã‚’å…¥ã‚Œã¦ã­ï¼‰
        const YOUTUBE_API_KEY = 'AIzaSyCNOHvaz0HS2c-kq7hDjmu4LEkZOn7EVuI';
        
        // ã‚«ãƒ†ã‚´ãƒªã¨è‰²ã®è¨­å®š
        const CATEGORIES = {
            'é…ä¿¡': {
                color: '#E74C3C',
                subCategories: ['ãƒ›ãƒ©ãƒ¼', 'ãƒˆãƒ¼ã‚¯', 'ã‚²ãƒ¼ãƒ å®Ÿæ³', 'ã‚³ãƒ©ãƒœ', 'ãã®ä»–']
            },
            'å¤§ä¼š': {
                color: '#3498DB',
                subCategories: ['å€‹äººæˆ¦', 'ãƒãƒ¼ãƒ æˆ¦', 'ãã®ä»–']
            },
            'ã‚ªãƒ•ã‚¤ãƒ™': {
                color: '#2ECC71',
                subCategories: ['ãƒ•ã‚¡ãƒ³ãƒŸ', 'ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¼”', 'ãã®ä»–']
            },
            'ã‚°ãƒƒã‚º': {
                color: '#F39C12',
                subCategories: ['é€šå¸¸è²©å£²', 'é™å®šè²©å£²', 'ãã®ä»–']
            }
        };
        
        const SUB_CATEGORY_COLORS = {
            'ãƒ›ãƒ©ãƒ¼': '#9B59B6',
            'ãƒˆãƒ¼ã‚¯': '#E67E22',
            'ã‚²ãƒ¼ãƒ å®Ÿæ³': '#1ABC9C',
            'ã‚³ãƒ©ãƒœ': '#E91E63',
            'å€‹äººæˆ¦': '#3498DB',
            'ãƒãƒ¼ãƒ æˆ¦': '#2980B9',
            'ãƒ•ã‚¡ãƒ³ãƒŸ': '#27AE60',
            'ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¼”': '#16A085',
            'é€šå¸¸è²©å£²': '#F39C12',
            'é™å®šè²©å£²': '#D35400',
            'ãã®ä»–': '#95A5A6'
        };
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let events = [];
        let currentDate = new Date();
        let selectedDate = null;
        let editingEventId = null;
        let currentStartTime = 22 * 60; // 22:00ã‚’åˆ†ã§ç®¡ç†
        let currentEndTime = 60; // 01:00ã‚’åˆ†ã§ç®¡ç†ï¼ˆç¿Œæ—¥ï¼‰
        let activeFilters = new Set();
        
        // åˆæœŸåŒ–
        function init() {
            loadEvents();
            initFilters();
            renderCalendar();
            updateSubCategories();
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–
        function initFilters() {
            const container = document.getElementById('filterCheckboxes');
            container.innerHTML = '';
            
            // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            Object.keys(CATEGORIES).forEach(category => {
                activeFilters.add(category);
                const item = document.createElement('div');
                item.className = 'filter-item';
                item.innerHTML = `
                    <input type="checkbox" id="filter-${category}" checked onchange="toggleFilter('${category}')">
                    <label for="filter-${category}" style="color: ${CATEGORIES[category].color}">${category}</label>
                `;
                container.appendChild(item);
            });
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function toggleFilter(category) {
            if (activeFilters.has(category)) {
                activeFilters.delete(category);
            } else {
                activeFilters.add(category);
            }
            renderCalendar();
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // æœˆè¡¨ç¤ºæ›´æ–°
            document.getElementById('currentMonth').textContent = 
                `${year}å¹´ ${month + 1}æœˆ`;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            calendar.innerHTML = '';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weekdays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay(); // 0 = æ—¥æ›œæ—¥
            
            // å‰æœˆã®æ—¥ä»˜
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const dayDiv = createDayCell(prevMonthLastDay - i, true, year, month - 1);
                calendar.appendChild(dayDiv);
            }
            
            // å½“æœˆã®æ—¥ä»˜
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayDiv = createDayCell(day, false, year, month);
                calendar.appendChild(dayDiv);
            }
            
            // æ¬¡æœˆã®æ—¥ä»˜ï¼ˆ6é€±åˆ†åŸ‹ã‚ã‚‹ï¼‰
            const totalCells = calendar.children.length - 7; // ãƒ˜ãƒƒãƒ€ãƒ¼é™¤ã
            const remainingCells = 42 - totalCells; // 6é€± Ã— 7æ—¥
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createDayCell(day, true, year, month + 1);
                calendar.appendChild(dayDiv);
            }
        }
        
        // æ—¥ä»˜ã‚»ãƒ«ä½œæˆ
        function createDayCell(day, isOtherMonth, year, month) {
            const div = document.createElement('div');
            div.className = 'calendar-day';
            if (isOtherMonth) {
                div.className += ' other-month';
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            div.appendChild(dayNumber);
            
            // ãã®æ—¥ã®äºˆå®šã‚’è¡¨ç¤º
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayEvents = events.filter(e => 
                e.date === dateStr && activeFilters.has(e.category)
            );
            
            dayEvents.forEach(event => {
    const eventDiv = document.createElement('div');
    eventDiv.className = 'event-item';
    eventDiv.style.background = SUB_CATEGORY_COLORS[event.subCategory] || CATEGORIES[event.category].color;
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’10æ–‡å­—ã§çœç•¥ + æ™‚é–“è¡¨ç¤º
    const shortTitle = event.title.length > 10 ? event.title.substring(0, 10) + '...' : event.title;
    eventDiv.innerHTML = `${shortTitle}<br>${event.startTime}-${event.endTime}`;
                eventDiv.onclick = (e) => {
                    e.stopPropagation();
                    openEditModal(event);
                };
                div.appendChild(eventDiv);
            });
            
            // æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯ã§æ–°è¦è¿½åŠ 
            div.onclick = () => {
                if (!isOtherMonth) {
                    openAddModal(dateStr);
                }
            };
            
            return div;
        }
        
        // æœˆå¤‰æ›´
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }
        
        // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªæ›´æ–°
        function updateSubCategories() {
            const category = document.getElementById('eventCategory').value;
            const subSelect = document.getElementById('eventSubCategory');
            subSelect.innerHTML = '';
            
            CATEGORIES[category].subCategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subSelect.appendChild(option);
            });
        }
        
        // æ™‚é–“èª¿æ•´
        function adjustTime(type, minutes) {
                const displayElement = document.getElementById(type === 'start' ? 'startTimeDisplay' : 'endTimeDisplay');
    let currentTime = timeToMinutes(displayElement.value);
    
    currentTime += minutes;
    if (currentTime < 0) currentTime += 24 * 60;
    if (currentTime >= 24 * 60) currentTime -= 24 * 60;
    
    displayElement.value = minutesToTime(currentTime);
    
    if (type === 'start') {
        currentStartTime = currentTime;
    } else {
        currentEndTime = currentTime;
    }
        }
        
        // åˆ†ã‚’æ™‚åˆ»ã«å¤‰æ›
        function minutesToTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        
        // æ™‚åˆ»ã‚’åˆ†ã«å¤‰æ›
        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

// YouTube ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function fetchYouTubeData() {
            const url = document.getElementById('youtubeUrl').value;
            const videoId = extractVideoId(url);
            
            if (!videoId) {
                alert('æ­£ã—ã„YouTube URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,liveStreamingDetails&id=${videoId}&key=${YOUTUBE_API_KEY}`
                );
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const video = data.items[0];
                    const title = video.snippet.title;
                    
                    // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
                    document.getElementById('eventTitle').value = title;
                    
                    // é…ä¿¡æ™‚åˆ»å–å¾—
                    let startTime, endTime;
                    
                    // ãƒ©ã‚¤ãƒ–é…ä¿¡ã®å ´åˆ
                    if (video.liveStreamingDetails) {
                        const actualStartTime = video.liveStreamingDetails.actualStartTime;
                        const actualEndTime = video.liveStreamingDetails.actualEndTime;
                        
                        if (actualStartTime) {
                            const start = new Date(actualStartTime);
                            startTime = `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')}`;
                            currentStartTime = timeToMinutes(startTime);
                            document.getElementById('startTimeDisplay').textContent = startTime;
                        }
                        
                        if (actualEndTime) {
                            const end = new Date(actualEndTime);
                            endTime = `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}`;
                            currentEndTime = timeToMinutes(endTime);
                            document.getElementById('endTimeDisplay').textContent = endTime;
                        } else if (actualStartTime) {
                            // çµ‚äº†æ™‚åˆ»ãŒãªã„å ´åˆã€å‹•ç”»æ™‚é–“ã‹ã‚‰è¨ˆç®—
                            const duration = parseDuration(video.contentDetails.duration);
                            currentEndTime = currentStartTime + duration;
                            if (currentEndTime >= 24 * 60) currentEndTime -= 24 * 60;
                            document.getElementById('endTimeDisplay').textContent = minutesToTime(currentEndTime);
                        }
                    } else {
                        // é€šå¸¸å‹•ç”»ã®å ´åˆã¯å…¬é–‹æ—¥æ™‚ã‚’ä½¿ç”¨
                        const publishedAt = new Date(video.snippet.publishedAt);
                        startTime = `${String(publishedAt.getHours()).padStart(2, '0')}:${String(publishedAt.getMinutes()).padStart(2, '0')}`;
                        currentStartTime = timeToMinutes(startTime);
                        document.getElementById('startTimeDisplay').textContent = startTime;
                        
                        // å‹•ç”»æ™‚é–“ã‹ã‚‰çµ‚äº†æ™‚åˆ»è¨ˆç®—
                        const duration = parseDuration(video.contentDetails.duration);
                        currentEndTime = currentStartTime + duration;
                        if (currentEndTime >= 24 * 60) currentEndTime -= 24 * 60;
                        document.getElementById('endTimeDisplay').textContent = minutesToTime(currentEndTime);
                    }
                    
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼');
                } else {
                    alert('å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // YouTubeå‹•ç”»IDã‚’æŠ½å‡º
        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }
        
        // ISO 8601 duration ã‚’åˆ†ã«å¤‰æ›
        function parseDuration(duration) {
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            const hours = parseInt(match[1] || 0);
            const minutes = parseInt(match[2] || 0);
            const seconds = parseInt(match[3] || 0);
            return hours * 60 + minutes + (seconds > 30 ? 1 : 0); // ç§’ã¯å››æ¨äº”å…¥
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆæ–°è¦è¿½åŠ ï¼‰
        function openAddModal(date) {
            selectedDate = date;
            editingEventId = null;
            
            document.getElementById('modalHeader').textContent = 'äºˆå®šã‚’è¿½åŠ ';
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventCategory').value = 'é…ä¿¡';
            updateSubCategories();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“è¨­å®š
            currentStartTime = 22 * 60; // 22:00
            currentEndTime = 60; // 01:00
            document.getElementById('startTimeDisplay').textContent = '22:00';
            document.getElementById('endTimeDisplay').textContent = '01:00';
            
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('eventModal').classList.add('active');
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆç·¨é›†ï¼‰
        function openEditModal(event) {
            selectedDate = event.date;
            editingEventId = event.id;
            
            document.getElementById('modalHeader').textContent = 'äºˆå®šã‚’ç·¨é›†';
            document.getElementById('youtubeUrl').value = event.youtubeUrl || '';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventCategory').value = event.category;
            updateSubCategories();
            document.getElementById('eventSubCategory').value = event.subCategory;
            
            currentStartTime = timeToMinutes(event.startTime);
            currentEndTime = timeToMinutes(event.endTime);
            document.getElementById('startTimeDisplay').textContent = event.startTime;
            document.getElementById('endTimeDisplay').textContent = event.endTime;
            
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('eventModal').classList.add('active');
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('eventModal').classList.remove('active');
        }
        
        // äºˆå®šã‚’ä¿å­˜
        function saveEvent() {
            const title = document.getElementById('eventTitle').value;
            const category = document.getElementById('eventCategory').value;
            const subCategory = document.getElementById('eventSubCategory').value;
            const youtubeUrl = document.getElementById('youtubeUrl').value;
            
            if (!title) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const event = {
                id: editingEventId || Date.now().toString(),
                date: selectedDate,
                title: title,
                category: category,
                subCategory: subCategory,
                startTime: minutesToTime(currentStartTime),
                endTime: minutesToTime(currentEndTime),
                youtubeUrl: youtubeUrl,
                color: SUB_CATEGORY_COLORS[subCategory] || CATEGORIES[category].color
            };
            
            if (editingEventId) {
                // ç·¨é›†
                const index = events.findIndex(e => e.id === editingEventId);
                events[index] = event;
            } else {
                // æ–°è¦è¿½åŠ 
                events.push(event);
            }
            
            saveEvents();
            renderCalendar();
            closeModal();
        }
        
        // äºˆå®šã‚’å‰Šé™¤
        function deleteEvent() {
            if (confirm('ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                events = events.filter(e => e.id !== editingEventId);
                saveEvents();
                renderCalendar();
                closeModal();
            }
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveEvents() {
            localStorage.setItem('scheduleEvents', JSON.stringify(events));
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadEvents() {
            const saved = localStorage.getItem('scheduleEvents');
            if (saved) {
                events = JSON.parse(saved);
            }
        }
        
        // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportJSON() {
            const dataStr = JSON.stringify(events, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `schedule-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        events = JSON.parse(event.target.result);
                        saveEvents();
                        renderCalendar();
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’æŠ½å‡º
        function extractChannelId(input) {
            // ãƒãƒ£ãƒ³ãƒãƒ«URLã®ãƒ‘ã‚¿ãƒ¼ãƒ³
            const patterns = [
                /youtube\.com\/channel\/([a-zA-Z0-9_-]+)/,
                /youtube\.com\/@([a-zA-Z0-9_-]+)/,
                /youtube\.com\/c\/([a-zA-Z0-9_-]+)/
            ];
            
            for (let pattern of patterns) {
                const match = input.match(pattern);
                if (match) return match[1];
            }
            
            // ãã®ã¾ã¾ãƒãƒ£ãƒ³ãƒãƒ«IDã¨ã—ã¦æ‰±ã†
            return input.trim();
        }
        
        // ä¸€æ‹¬å–å¾—
        async function bulkFetchVideos() {
            const channelInput = document.getElementById('channelUrl').value;
            const startDate = document.getElementById('fetchStartDate').value;
            const endDate = document.getElementById('fetchEndDate').value;
            
            if (!channelInput) {
                alert('ãƒãƒ£ãƒ³ãƒãƒ«URLã¾ãŸã¯IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!startDate || !endDate) {
                alert('å–å¾—ã™ã‚‹æœŸé–“ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            const channelId = extractChannelId(channelInput);
            
            // æ—¥ä»˜ã‚’ISOå½¢å¼ã«å¤‰æ›
            const publishedAfter = new Date(startDate).toISOString();
            const publishedBefore = new Date(endDate + 'T23:59:59').toISOString();
            
            try {
                // ã¾ãšãƒãƒ£ãƒ³ãƒãƒ«IDã‹ã‚‰å‹•ç”»ã‚’æ¤œç´¢
                const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&publishedAfter=${publishedAfter}&publishedBefore=${publishedBefore}&maxResults=50&order=date&type=video&key=${YOUTUBE_API_KEY}`;
                
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();
                
                if (!searchData.items || searchData.items.length === 0) {
                    alert('æŒ‡å®šæœŸé–“ã®å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }
                
                // å„å‹•ç”»ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
                const videoIds = searchData.items.map(item => item.id.videoId).join(',');
                const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,liveStreamingDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                
                const detailsResponse = await fetch(detailsUrl);
                const detailsData = await detailsResponse.json();
                
                let addedCount = 0;
                
                // å„å‹•ç”»ã‚’äºˆå®šã¨ã—ã¦è¿½åŠ 
                detailsData.items.forEach(video => {
                    const title = video.snippet.title;
                    let videoDate, startTime, endTime;
                    
                    // ãƒ©ã‚¤ãƒ–é…ä¿¡ã®å ´åˆ
                    if (video.liveStreamingDetails && video.liveStreamingDetails.actualStartTime) {
                        const start = new Date(video.liveStreamingDetails.actualStartTime);
                        videoDate = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}-${String(start.getDate()).padStart(2, '0')}`;
                        startTime = `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')}`;
                        
                        if (video.liveStreamingDetails.actualEndTime) {
                            const end = new Date(video.liveStreamingDetails.actualEndTime);
                            endTime = `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}`;
                        } else {
                            const duration = parseDuration(video.contentDetails.duration);
                            const endMinutes = timeToMinutes(startTime) + duration;
                            endTime = minutesToTime(endMinutes >= 24 * 60 ? endMinutes - 24 * 60 : endMinutes);
                        }
                    } else {
                        // é€šå¸¸å‹•ç”»ã®å ´åˆ
                        const published = new Date(video.snippet.publishedAt);
                        videoDate = `${published.getFullYear()}-${String(published.getMonth() + 1).padStart(2, '0')}-${String(published.getDate()).padStart(2, '0')}`;
                        startTime = `${String(published.getHours()).padStart(2, '0')}:${String(published.getMinutes()).padStart(2, '0')}`;
                        
                        const duration = parseDuration(video.contentDetails.duration);
                        const endMinutes = timeToMinutes(startTime) + duration;
                        endTime = minutesToTime(endMinutes >= 24 * 60 ? endMinutes - 24 * 60 : endMinutes);
                    }
                    
                    const event = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        date: videoDate,
                        title: title,
                        category: 'é…ä¿¡',
                        subCategory: 'ãã®ä»–',
                        startTime: startTime,
                        endTime: endTime,
                        youtubeUrl: `https://www.youtube.com/watch?v=${video.id}`,
                        color: SUB_CATEGORY_COLORS['ãã®ä»–']
                    };
                    
                    events.push(event);
                    addedCount++;
                });
                
                saveEvents();
                renderCalendar();
                alert(`${addedCount}ä»¶ã®å‹•ç”»ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nã‚«ãƒ†ã‚´ãƒªã¯å¾Œã§ç·¨é›†ã—ã¦ã­ã€‚`);
                
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                console.error(error);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.onload = init;

    </script>
</body>
</html>